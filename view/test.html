<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>Document</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet">
</head>
<body>
<div class="container">
    <img src="https://s3.ap-northeast-2.amazonaws.com/s3.kakao-klip-login/images/a.jpeg" alt="..." />
    <button id="prepare">Step.1 Prepare & Render Kakaotalk</button>
<!--    <button id="web2appTestBtn">Step2. Render Kakaotalk</button>-->
    <button id="getWallet">Step.2 Get Wallet</button>
    <div hidden id="requestKey"></div>
    <div>Wallet Address</div>
    <div id="walletAddr"></div>
</div>

<script crossorigin="anonymous"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="/static/web2app.js" type="text/javascript"></script>
<script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

<script>
    const prepare = document.getElementById("prepare")
    const requestKey = document.getElementById("requestKey")

    prepare.addEventListener("click", async () => {
        await prepareF()
        setTimeout(()=>{
            openKakaotalk()
        },1000)
        // alert("완료")
    })


    function prepareF() {
        const formData = {
            bapp: {
                name: "test",
                callback: {
                    success: "test://",
                    fail: "test://",
                },
            },
            type: "auth",
        }
        $.ajax({
            url: "https://a2a-api.klipwallet.com/v2/a2a/prepare",
            type: "POST",
            data: JSON.stringify(formData),
            dataType: "json",
            contentType: "application/json",
            success: function (data) {
                requestKey.innerText = data.request_key
                console.log(data)
            },
            error: function (error) {
                console.log(error)
            }
        });
    }
    const walletAddr = document.getElementById("walletAddr")
    const getWallet = document.getElementById("getWallet")
    getWallet.addEventListener("click", () => {
        getWalletF()
        // alert("지갑주소를 가져옴")
    })

    function getWalletF() {
        $.ajax({
            url: `https://a2a-api.klipwallet.com/v2/a2a/result?request_key=${requestKey.innerText}`,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            success: function (data) {
                walletAddr.innerText = data.result.klaytn_address
            },
            error: function (error) {
                console.log(error)
            }
        });
    }

    function checkMobile() {

        var varUA = navigator.userAgent.toLowerCase(); //userAgent 값 얻기

        if (varUA.indexOf('android') > -1) {
            //안드로이드
            return "android";
        } else if (varUA.indexOf("iphone") > -1 || varUA.indexOf("ipad") > -1 || varUA.indexOf("ipod") > -1) {
            //IOS
            return "ios";
        } else {
            //아이폰, 안드로이드 외
            return "other";
        }

    }

    const type = checkMobile()

    // var ua = navigator.userAgent;

    var btnEl = document.getElementById('web2appTestBtn'),
        scheme = 'kakaolink',
        pkgName = 'com.kakao.talk',
        urlScheme = `kakaolink://send?appkey=${requestKey.innerText}`,
        intentURI = `intent://send?appkey=${requestKey.innerText}`,
        appStoreURL = (type === "android") ? 'market://details?id=' + pkgName : 'itms-apps://itunes.apple.com/app/id362057947';

    btnEl.addEventListener('click', function () {
        openKakaotalk()
    });

    function openKakaotalk(){
        window.open(`kakaotalk://klipwallet/open?url=https://klipwallet.com/?target=/a2a?request_key=${requestKey.innerText}`)
    }

</script>
</body>
</html>